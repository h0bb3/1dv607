<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" integrity="sha384-JcKb8q3iqJ61gNV9KGb8thSsNjpSL0n8PARn9HuZOnIxN0hoP+VmmDGMN5t9UJ0Z" crossorigin="anonymous">

    <title>Hello, world!</title>
    <style>
        .table-hover > tbody > .no-hover>td:hover {
            background-color: green !important;
        }



    </style>
</head>
<body>
<h1>Hello StudSys World!</h1>
<div id="server_message"></div>
<div id="main_menu"><button type="button" class="btn btn-outline-primary" onclick="ws.send('AddNewStudent')">Add Student</button> <button type="button" class="btn btn-outline-primary" onclick='ws.send("ListAllStudents")'>List Students</button> <button type="button" class="btn btn-outline-secondary">Quit</button></div>
<div id="students">
    <table class="table table-hover table-striped">
        <thead>
            <tr><th>Name</th><th>Email</th></tr>
        </thead>
        <tbody></tbody>
    </table>
    <button type="button" class="btn btn-outline-secondary" onclick='ws.send("none")'>Back...</button>
</div>

<div id="student">
    <label for="name">Name</label>
    <input type="text" class="form-control" id="name">
    <label for="email">Email address</label>
    <input type="email" class="form-control" id="email" aria-describedby="emailHelp">
    <button type="button" class="btn btn-outline-secondary" onclick='wantsToChangeStudent = false; wantsToDeleteStudent = false; ws.send("false")'>Cancel</button><button type="button" id="student_action_button" class="btn btn-outline-primary" onclick=''>Add Student</button>
</div>

<!-- Optional JavaScript -->
<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.5.1.slim.min.js" integrity="sha384-DfXdz2htPH0lsSSs5nCTpuj/zy4C+OGpamoFVy38MVBnE+IbbVYUew+OrCXaRkfj" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js" integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN" crossorigin="anonymous"></script>
<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" integrity="sha384-B4gt1jrGC7Jh4AgTPSdUtOBvfO8shuf57BaghqFfPlYxofvL8/KUEfYiJOMMV+rV" crossorigin="anonymous"></script>

<script>

    function populateStudentForm(msg) {

        var getName = '$("#name").val()'
        var getEmail = '$("#email").val()'
        $("#student_action_button").attr("onclick", "ws.send('true:' + " + getName + " + ':' + " + getEmail + ")")

        console.log("populateStudentForm");

        if (msg == "showStudentForm") {
            // add new student
            $("#student_action_button").text("Add Student");

        } else {
            // change existing student
             $("#student_action_button").text("Change Student");
             parts = msg.split(":")
             $("#name").val(parts[1])
             $("#email").val(parts[2])
        }
    }

    function populateStudentsTable(msg) {
        parts = msg.split(":")
        $("#students table tbody").remove()
        $("#students table").append("<tbody></tbody>")
        var studentIx = 0
        var startIx = 1
        if (msg.startsWith("onAddNewStudent")) {
            startIx = 3
        }
        for (var i = startIx; i < parts.length; i+=2, studentIx++) {

            $("#students table tbody").append("<tr ><td onclick='ws.send(" + studentIx +"); wantsToChangeStudent=true;'>" + parts[i] + "</td><td onclick='ws.send(" + studentIx +"); wantsToChangeStudent=true;'>" + parts[i + 1] + "</td><td class='no-hover'><button type='btn' class='btn btn-outline-danger btn-sm' onclick='ws.send(" + studentIx +"); wantsToDeleteStudent=true;'>Delete</button></td></tr>");
        }
    }
    var ws

    // these should probably be handled differently
    // communication via global variables... mmmh
    var wantsToChangeStudent = false
    var wantsToDeleteStudent = false

    $(document).ready(function() {
        $("#main_menu").hide();
        $("#students").hide();

        ws = new WebSocket("ws://127.0.0.1:1717");
        ws.onopen = function () {

             ws.onmessage = function (evt) {
                //$("#server_message").append(event.data + "</br>");
                if (event.data === "getAdminOptions") {
                    $("#main_menu").show();
                    $("#students").hide();
                    $("#student").hide();
                } else if (event.data.startsWith("showStudentList")) {
                    $("#main_menu").hide();
                    $("#student").hide();

                    wantsToChangeStudent = false
                    wantsToDeleteStudent = false

                    populateStudentsTable(event.data);
                    $("#students").show();
                } else if (event.data.startsWith("showStudentForm")) {
                    $("#main_menu").hide();
                    $("#students").hide();
                    populateStudentForm(event.data)
                    $("#student").show();

                } else if (event.data.startsWith("onAddNewStudent")) {
                    if ($("#students").is(":visible")) {
                        populateStudentsTable(event.data);
                    }
                } else if (event.data.startsWith("getStudentOption")) {
                    if (wantsToChangeStudent) {
                        ws.send("Change")
                    } else if (wantsToDeleteStudent) {
                        ws.send("Delete")
                    } else {
                        ws.send("None")
                    }

                    wantsToChangeStudent = false
                    wantsToDeleteStudent = false
                } else if (event.data.startsWith("onChangedStudent")) {
                    if ($("#student").is(":visible")) {
                        populateStudentForm(event.data)
                    }
                } else if (event.data.startsWith("onDeletedStudent")) {
                    // TODO
                }

                console.log(event.data);
            }

            ws.send("ready")
        }
     });


</script>

</body>
</html>